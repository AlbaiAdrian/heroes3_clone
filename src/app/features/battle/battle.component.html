<div class="heroes-root" *ngIf="state">
  <header class="top-bar">
    <div class="battle-title">Battle — Round {{ state.round }}</div>
    <div class="battle-turn" *ngIf="!state.result">
      <span class="turn-label">Current Turn</span>
      <span class="turn-name">{{ currentUnit?.creatureType?.name }}</span>
      <span class="turn-side">{{ currentUnit?.isAttacker ? 'Attacker' : 'Defender' }}</span>
    </div>
    <div class="battle-turn" *ngIf="state.result">
      <span class="turn-label">Battle Result</span>
      <span class="turn-name">{{ resultText }}</span>
    </div>
  </header>

  <div class="battle-layout">
    <section class="panel army-panel attacker-panel">
      <h3>Attacker</h3>
      <div class="unit-list">
        <div
          *ngFor="let unit of state.attackerUnits"
          class="unit-card"
          [class.dead]="unit.isDead"
          [class.active]="unit === currentUnit"
        >
          <button class="unit-sprite" type="button" (click)="openSprite(unit)">
            <img
              [attr.src]="getCreatureSpritePath(unit)"
              [attr.alt]="unit.creatureType.name + (unit.isDead ? ' (Dead)' : '')"
            />
          </button>
          <div class="unit-info">
            <div class="unit-name">{{ unit.creatureType.name }}</div>
            <div class="unit-meta">
              <span>Qty: {{ unit.quantity }}</span>
              <span>HP: {{ unit.currentHp }}/{{ unit.maxHp }}</span>
              <span>Atk: {{ getAttackValue(unit) }}</span>
              <span>Def: {{ getDefenseValue(unit) }}</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="battle-center">
      <div class="panel turn-panel" *ngIf="!state.result">
        <h3>Orders</h3>
        <p class="turn-summary">Select a target to attack:</p>
        <div class="targets" *ngIf="targets.length > 0; else noTargets">
          <button
            *ngFor="let target of targets"
            class="btn btn-secondary"
            (click)="attackTarget(target)"
          >
            Attack {{ target.creatureType.name }} ({{ target.quantity }})
          </button>
        </div>
        <ng-template #noTargets>
          <p class="turn-summary muted">No valid targets.</p>
        </ng-template>
      </div>

      <div class="panel result-panel" *ngIf="state.result">
        <h3 class="result-title">{{ resultText }}</h3>
        <p class="turn-summary">The battle has ended.</p>
      </div>

      <div class="panel battle-log">
        <h4>Battle Log</h4>
        <div class="log-entries">
          <p *ngFor="let entry of state.log">{{ entry }}</p>
        </div>
      </div>
    </section>

    <section class="panel army-panel defender-panel">
      <h3>Defender</h3>
      <div class="unit-list">
        <div
          *ngFor="let unit of state.defenderUnits"
          class="unit-card"
          [class.dead]="unit.isDead"
          [class.active]="unit === currentUnit"
        >
          <button class="unit-sprite" type="button" (click)="openSprite(unit)">
            <img
              [attr.src]="getCreatureSpritePath(unit)"
              [attr.alt]="unit.creatureType.name + (unit.isDead ? ' (Dead)' : '')"
            />
          </button>
          <div class="unit-info">
            <div class="unit-name">{{ unit.creatureType.name }}</div>
            <div class="unit-meta">
              <span>Qty: {{ unit.quantity }}</span>
              <span>HP: {{ unit.currentHp }}/{{ unit.maxHp }}</span>
              <span>Atk: {{ getAttackValue(unit) }}</span>
              <span>Def: {{ getDefenseValue(unit) }}</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="bottom-bar">
    <button *ngIf="!state.result" class="btn btn-secondary" (click)="retreat()">Retreat</button>
    <button *ngIf="state.result" class="btn btn-secondary" (click)="endBattle()">Return to Map</button>
  </footer>
</div>

<div class="sprite-modal" *ngIf="selectedUnit as unit" (click)="closeSprite()">
  <div class="sprite-modal-content" (click)="$event.stopPropagation()">
    <button type="button" class="modal-close" (click)="closeSprite()">×</button>
    <img
      [attr.src]="getCreatureSpritePath(unit)"
      [attr.alt]="unit.creatureType.name + ' portrait'"
    />
    <div class="modal-details">
      <div class="unit-name">{{ unit.creatureType.name }}</div>
      <div class="modal-stats">
        <span>Attack: {{ getAttackValue(unit) }}</span>
        <span>Defense: {{ getDefenseValue(unit) }}</span>
      </div>
    </div>
  </div>
</div>
